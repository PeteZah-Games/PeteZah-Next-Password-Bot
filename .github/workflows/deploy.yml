name: Deploy on Push

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with: 
        fetch-depth: 1
        sparse-checkout: true
        sparse-checkout-paths: |
          - index.js
          - register-commands.js
          - package.json
        sparse-checkout-cone-mode: false  # Ensures manual path control

    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
        chmod 600 ~/.ssh/id_ed25519
        ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts
        export GIT_SSH_COMMAND="ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=yes"

    - name: Deploy to server
      run: |
        ssh -i ~/.ssh/id_ed25519 ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
          set -e  # Exit on error
          cd ./pzn-bot || { echo "Directory ./pzn-bot not found"; exit 1; }

          echo "Pulling latest code..."
          git pull || { echo "Git pull failed"; exit 1; }

          echo "Installing dependencies..."
          npm install || { echo "npm install failed"; exit 1; }

          timestamp=$(date +"[%I:%M:%S %p %Z]")
          echo "$timestamp PeteZah-Next start initiated at $timestamp"
          echo "$timestamp PeteZah-Next start initiated at $timestamp" >> out.log

          echo "Restarting application..."
          pkill -f "node ./index.js" || echo "No running process found"

          nohup bash -c 'npm run start-ubuntu 2>&1 | awk '\''{ \
            cstcmd="TZ=America/Chicago date +\"[CST: %Y-%m-%d %I:%M:%S %p]\""; \
            utc="TZ=UTC date +\"[UTC: %Y-%m-%d %I:%M:%S %p]\""; \
            cstcmd | getline cst; close(cstcmd); \
            utc | getline u; close(utc); \
            print cst, u, $0; fflush(); \
          }'\'' >> out.log' </dev/null >/dev/null 2>&1 &
        EOF
